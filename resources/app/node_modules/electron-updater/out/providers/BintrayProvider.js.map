{"version":3,"sources":["../../src/providers/BintrayProvider.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEM,MAAO,eAAP,SAA+B,gBAA/B,CAAmD;AAIvD,EAAA,WAAA,CAAY,aAAZ,EAA2C,cAA3C,EAAiF;AAC/E,UAAM,cAAN;AAEA,SAAK,MAAL,GAAc,KAAI,wBAAJ,EAAkB,aAAlB,EAAiC,cAAc,CAAC,QAAhD,EAA0D,KAAI,uCAAJ,GAA1D,CAAd;AACA,SAAK,OAAL,GAAe,wBAAW,0BAA0B,KAAK,MAAL,CAAY,KAAK,IAAI,KAAK,MAAL,CAAY,IAAI,EAA1E,CAAf;AACD;;AAED,EAAA,iBAAiB,CAAC,KAAD,EAAW;AAC1B,UAAM,iBAAN,CAAwB,KAAxB;AACA,SAAK,MAAL,CAAY,iBAAZ,CAA8B,KAA9B;AACD;;AAEK,EAAA,gBAAN,GAAsB;AAAA;;AAAA;AACpB,UAAI;AACF,cAAM,IAAI,SAAS,KAAI,CAAC,MAAL,CAAY,UAAZ,CAAuB,SAAvB,CAAnB;AACA,cAAM,eAAe,GAAG,gCAAmB,KAAI,CAAC,qBAAL,EAAnB,CAAxB;AACA,cAAM,KAAK,SAAS,KAAI,CAAC,MAAL,CAAY,eAAZ,CAA4B,IAAI,CAAC,IAAjC,CAApB;AACA,cAAM,WAAW,GAAG,KAAK,CAAC,IAAN,CAAW,EAAE,IAAI,EAAE,CAAC,IAAH,CAAQ,QAAR,CAAiB,IAAI,eAAe,EAApC,KAA2C,EAAE,CAAC,IAAH,CAAQ,QAAR,CAAiB,IAAI,eAAe,EAApC,CAA5D,CAApB;;AACA,YAAI,WAAW,IAAI,IAAnB,EAAyB;AACvB;AACA,gBAAM,oCAAS,6BAA6B,eAAe,uBAAuB,KAAK,CAAC,GAAN,CAAU,EAAE,IAAI,IAAI,CAAC,SAAL,CAAe,EAAf,EAAmB,IAAnB,EAAyB,CAAzB,CAAhB,EAA6C,IAA7C,CAAkD,KAAlD,CAAwD,EAApI,EAAwI,oCAAxI,CAAN;AACD;;AAED,cAAM,cAAc,GAAG,KAAI,UAAJ,EAAQ,0BAA0B,KAAI,CAAC,MAAL,CAAY,KAAK,IAAI,KAAI,CAAC,MAAL,CAAY,IAAI,IAAI,WAAW,CAAC,IAAI,EAA3F,CAAvB;AACA,eAAO,wCAAsB,KAAI,CAAC,WAAL,CAAiB,cAAjB,CAAtB,GAAwD,eAAxD,EAAyE,cAAzE,CAAP;AACD,OAZD,CAaA,OAAO,CAAP,EAAU;AACR,YAAI,gBAAgB,CAAhB,IAAqB,CAAC,CAAC,UAAF,KAAiB,GAA1C,EAA+C;AAC7C,gBAAM,oCAAS,kIAAkI,CAAC,CAAC,KAAF,IAAW,CAAC,CAAC,OAAO,EAA/J,EAAmK,sCAAnK,CAAN;AACD;;AACD,cAAM,CAAN;AACD;AAnBmB;AAoBrB;;AAED,EAAA,YAAY,CAAC,UAAD,EAAuB;AACjC,WAAO,8BAAa,UAAb,EAAyB,KAAK,OAA9B,CAAP;AACD;;AAxCsD,C","sourcesContent":["import { BintrayOptions, CancellationToken, newError, UpdateInfo } from \"builder-util-runtime\"\nimport { BintrayClient } from \"builder-util-runtime/out/bintray\"\nimport { URL } from \"url\"\nimport { getChannelFilename, newBaseUrl, Provider, ResolvedUpdateFileInfo } from \"../main\"\nimport { parseUpdateInfo, ProviderRuntimeOptions, resolveFiles } from \"./Provider\"\n\nexport class BintrayProvider extends Provider<UpdateInfo> {\n  private client: BintrayClient\n  private readonly baseUrl: URL\n\n  constructor(configuration: BintrayOptions, runtimeOptions: ProviderRuntimeOptions) {\n    super(runtimeOptions)\n\n    this.client = new BintrayClient(configuration, runtimeOptions.executor, new CancellationToken())\n    this.baseUrl = newBaseUrl(`https://dl.bintray.com/${this.client.owner}/${this.client.repo}`)\n  }\n\n  setRequestHeaders(value: any): void {\n    super.setRequestHeaders(value)\n    this.client.setRequestHeaders(value)\n  }\n\n  async getLatestVersion(): Promise<UpdateInfo> {\n    try {\n      const data = await this.client.getVersion(\"_latest\")\n      const channelFilename = getChannelFilename(this.getDefaultChannelName())\n      const files = await this.client.getVersionFiles(data.name)\n      const channelFile = files.find(it => it.name.endsWith(`_${channelFilename}`) || it.name.endsWith(`-${channelFilename}`))\n      if (channelFile == null) {\n        // noinspection ExceptionCaughtLocallyJS\n        throw newError(`Cannot find channel file \"${channelFilename}\", existing files:\\n${files.map(it => JSON.stringify(it, null, 2)).join(\",\\n\")}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\n      }\n\n      const channelFileUrl = new URL(`https://dl.bintray.com/${this.client.owner}/${this.client.repo}/${channelFile.name}`)\n      return parseUpdateInfo(await this.httpRequest(channelFileUrl), channelFilename, channelFileUrl)\n    }\n    catch (e) {\n      if (\"statusCode\" in e && e.statusCode === 404) {\n        throw newError(`No latest version, please ensure that user, package and repository correctly configured. Or at least one version is published. ${e.stack || e.message}`, \"ERR_UPDATER_LATEST_VERSION_NOT_FOUND\")\n      }\n      throw e\n    }\n  }\n\n  resolveFiles(updateInfo: UpdateInfo): Array<ResolvedUpdateFileInfo> {\n    return resolveFiles(updateInfo, this.baseUrl)\n  }\n}"],"sourceRoot":""}
